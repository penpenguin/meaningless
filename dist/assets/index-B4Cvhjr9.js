var Ct=Object.defineProperty;var Tt=(b,t,s)=>t in b?Ct(b,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):b[t]=s;var c=(b,t,s)=>Tt(b,typeof t!="symbol"?t+"":t,s);import{E as Pt,V as f,M as K,T as Q,S as je,Q as be,a as x,R as Et,P as Rt,b as At,O as zt,G as V,C as S,I as Dt,D as kt,c as Ft,d as Lt,e as Ot,f as se,B as Se,g as Y,h as O,i as ae,F as Bt,j as X,k as H,A as Ze,l as It,m as _t,n as Ut,o as Nt,p as $e,q as ve,r as Je,s as N,t as Gt,u as jt,v as Vt,w as Ve,U as xe,W as ie,H as he,N as Ht,x as et,y as Yt,z as Wt,L as He,J as qt,K as Kt,X as Qt,Y as Xt,Z as Zt,_ as $t,$ as Ye,a0 as Jt,a1 as We,a2 as ge,a3 as es,a4 as ts,a5 as ye,a6 as we}from"./three-Dsb5-zte.js";import{l as ss}from"./lottie-D_akyxJo.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))e(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function s(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(a){if(a.ep)return;a.ep=!0;const o=s(a);fetch(a.href,o)}})();const qe={type:"change"},Me={type:"start"},Ke={type:"end"},ce=new Et,Qe=new Rt,as=Math.cos(70*At.DEG2RAD);class is extends Pt{constructor(t,s){super(),this.object=t,this.domElement=s,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new f,this.cursor=new f,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:K.ROTATE,MIDDLE:K.DOLLY,RIGHT:K.PAN},this.touches={ONE:Q.ROTATE,TWO:Q.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return r.phi},this.getAzimuthalAngle=function(){return r.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(i){i.addEventListener("keydown",pe),this._domElementKeyEvents=i},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",pe),this._domElementKeyEvents=null},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(qe),e.update(),o=a.NONE},this.update=function(){const i=new f,m=new be().setFromUnitVectors(t.up,new f(0,1,0)),y=m.clone().invert(),v=new f,E=new be,j=new f,k=2*Math.PI;return function(St=null){const Ge=e.object.position;i.copy(Ge).sub(e.target),i.applyQuaternion(m),r.setFromVector3(i),e.autoRotate&&o===a.NONE&&I($(St)),e.enableDamping?(r.theta+=l.theta*e.dampingFactor,r.phi+=l.phi*e.dampingFactor):(r.theta+=l.theta,r.phi+=l.phi);let _=e.minAzimuthAngle,U=e.maxAzimuthAngle;isFinite(_)&&isFinite(U)&&(_<-Math.PI?_+=k:_>Math.PI&&(_-=k),U<-Math.PI?U+=k:U>Math.PI&&(U-=k),_<=U?r.theta=Math.max(_,Math.min(U,r.theta)):r.theta=r.theta>(_+U)/2?Math.max(_,r.theta):Math.min(U,r.theta)),r.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,r.phi)),r.makeSafe(),e.enableDamping===!0?e.target.addScaledVector(d,e.dampingFactor):e.target.add(d),e.target.sub(e.cursor),e.target.clampLength(e.minTargetRadius,e.maxTargetRadius),e.target.add(e.cursor),e.zoomToCursor&&G||e.object.isOrthographicCamera?r.radius=me(r.radius):r.radius=me(r.radius*h),i.setFromSpherical(r),i.applyQuaternion(y),Ge.copy(e.target).add(i),e.object.lookAt(e.target),e.enableDamping===!0?(l.theta*=1-e.dampingFactor,l.phi*=1-e.dampingFactor,d.multiplyScalar(1-e.dampingFactor)):(l.set(0,0,0),d.set(0,0,0));let re=!1;if(e.zoomToCursor&&G){let ee=null;if(e.object.isPerspectiveCamera){const te=i.length();ee=me(te*h);const le=te-ee;e.object.position.addScaledVector(z,le),e.object.updateMatrixWorld()}else if(e.object.isOrthographicCamera){const te=new f(D.x,D.y,0);te.unproject(e.object),e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/h)),e.object.updateProjectionMatrix(),re=!0;const le=new f(D.x,D.y,0);le.unproject(e.object),e.object.position.sub(le).add(te),e.object.updateMatrixWorld(),ee=i.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),e.zoomToCursor=!1;ee!==null&&(this.screenSpacePanning?e.target.set(0,0,-1).transformDirection(e.object.matrix).multiplyScalar(ee).add(e.object.position):(ce.origin.copy(e.object.position),ce.direction.set(0,0,-1).transformDirection(e.object.matrix),Math.abs(e.object.up.dot(ce.direction))<as?t.lookAt(e.target):(Qe.setFromNormalAndCoplanarPoint(e.object.up,e.target),ce.intersectPlane(Qe,e.target))))}else e.object.isOrthographicCamera&&(re=h!==1,re&&(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/h)),e.object.updateProjectionMatrix()));return h=1,G=!1,re||v.distanceToSquared(e.object.position)>n||8*(1-E.dot(e.object.quaternion))>n||j.distanceToSquared(e.target)>0?(e.dispatchEvent(qe),v.copy(e.object.position),E.copy(e.object.quaternion),j.copy(e.target),!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",Ue),e.domElement.removeEventListener("pointerdown",Oe),e.domElement.removeEventListener("pointercancel",J),e.domElement.removeEventListener("wheel",Be),e.domElement.removeEventListener("pointermove",fe),e.domElement.removeEventListener("pointerup",J),e._domElementKeyEvents!==null&&(e._domElementKeyEvents.removeEventListener("keydown",pe),e._domElementKeyEvents=null)};const e=this,a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let o=a.NONE;const n=1e-6,r=new je,l=new je;let h=1;const d=new f,u=new x,g=new x,p=new x,w=new x,M=new x,T=new x,C=new x,A=new x,R=new x,z=new f,D=new x;let G=!1;const P=[],F={};let L=!1;function $(i){return i!==null?2*Math.PI/60*e.autoRotateSpeed*i:2*Math.PI/60/60*e.autoRotateSpeed}function B(i){const m=Math.abs(i*.01);return Math.pow(.95,e.zoomSpeed*m)}function I(i){l.theta-=i}function ne(i){l.phi-=i}const Ce=function(){const i=new f;return function(y,v){i.setFromMatrixColumn(v,0),i.multiplyScalar(-y),d.add(i)}}(),Te=function(){const i=new f;return function(y,v){e.screenSpacePanning===!0?i.setFromMatrixColumn(v,1):(i.setFromMatrixColumn(v,0),i.crossVectors(e.object.up,i)),i.multiplyScalar(y),d.add(i)}}(),W=function(){const i=new f;return function(y,v){const E=e.domElement;if(e.object.isPerspectiveCamera){const j=e.object.position;i.copy(j).sub(e.target);let k=i.length();k*=Math.tan(e.object.fov/2*Math.PI/180),Ce(2*y*k/E.clientHeight,e.object.matrix),Te(2*v*k/E.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(Ce(y*(e.object.right-e.object.left)/e.object.zoom/E.clientWidth,e.object.matrix),Te(v*(e.object.top-e.object.bottom)/e.object.zoom/E.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function de(i){e.object.isPerspectiveCamera||e.object.isOrthographicCamera?h/=i:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function Pe(i){e.object.isPerspectiveCamera||e.object.isOrthographicCamera?h*=i:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ue(i,m){if(!e.zoomToCursor)return;G=!0;const y=e.domElement.getBoundingClientRect(),v=i-y.left,E=m-y.top,j=y.width,k=y.height;D.x=v/j*2-1,D.y=-(E/k)*2+1,z.set(D.x,D.y,1).unproject(e.object).sub(e.object.position).normalize()}function me(i){return Math.max(e.minDistance,Math.min(e.maxDistance,i))}function Ee(i){u.set(i.clientX,i.clientY)}function nt(i){ue(i.clientX,i.clientX),C.set(i.clientX,i.clientY)}function Re(i){w.set(i.clientX,i.clientY)}function rt(i){g.set(i.clientX,i.clientY),p.subVectors(g,u).multiplyScalar(e.rotateSpeed);const m=e.domElement;I(2*Math.PI*p.x/m.clientHeight),ne(2*Math.PI*p.y/m.clientHeight),u.copy(g),e.update()}function lt(i){A.set(i.clientX,i.clientY),R.subVectors(A,C),R.y>0?de(B(R.y)):R.y<0&&Pe(B(R.y)),C.copy(A),e.update()}function ct(i){M.set(i.clientX,i.clientY),T.subVectors(M,w).multiplyScalar(e.panSpeed),W(T.x,T.y),w.copy(M),e.update()}function ht(i){ue(i.clientX,i.clientY),i.deltaY<0?Pe(B(i.deltaY)):i.deltaY>0&&de(B(i.deltaY)),e.update()}function dt(i){let m=!1;switch(i.code){case e.keys.UP:i.ctrlKey||i.metaKey||i.shiftKey?ne(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):W(0,e.keyPanSpeed),m=!0;break;case e.keys.BOTTOM:i.ctrlKey||i.metaKey||i.shiftKey?ne(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):W(0,-e.keyPanSpeed),m=!0;break;case e.keys.LEFT:i.ctrlKey||i.metaKey||i.shiftKey?I(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):W(e.keyPanSpeed,0),m=!0;break;case e.keys.RIGHT:i.ctrlKey||i.metaKey||i.shiftKey?I(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):W(-e.keyPanSpeed,0),m=!0;break}m&&(i.preventDefault(),e.update())}function Ae(i){if(P.length===1)u.set(i.pageX,i.pageY);else{const m=q(i),y=.5*(i.pageX+m.x),v=.5*(i.pageY+m.y);u.set(y,v)}}function ze(i){if(P.length===1)w.set(i.pageX,i.pageY);else{const m=q(i),y=.5*(i.pageX+m.x),v=.5*(i.pageY+m.y);w.set(y,v)}}function De(i){const m=q(i),y=i.pageX-m.x,v=i.pageY-m.y,E=Math.sqrt(y*y+v*v);C.set(0,E)}function ut(i){e.enableZoom&&De(i),e.enablePan&&ze(i)}function mt(i){e.enableZoom&&De(i),e.enableRotate&&Ae(i)}function ke(i){if(P.length==1)g.set(i.pageX,i.pageY);else{const y=q(i),v=.5*(i.pageX+y.x),E=.5*(i.pageY+y.y);g.set(v,E)}p.subVectors(g,u).multiplyScalar(e.rotateSpeed);const m=e.domElement;I(2*Math.PI*p.x/m.clientHeight),ne(2*Math.PI*p.y/m.clientHeight),u.copy(g)}function Fe(i){if(P.length===1)M.set(i.pageX,i.pageY);else{const m=q(i),y=.5*(i.pageX+m.x),v=.5*(i.pageY+m.y);M.set(y,v)}T.subVectors(M,w).multiplyScalar(e.panSpeed),W(T.x,T.y),w.copy(M)}function Le(i){const m=q(i),y=i.pageX-m.x,v=i.pageY-m.y,E=Math.sqrt(y*y+v*v);A.set(0,E),R.set(0,Math.pow(A.y/C.y,e.zoomSpeed)),de(R.y),C.copy(A);const j=(i.pageX+m.x)*.5,k=(i.pageY+m.y)*.5;ue(j,k)}function ft(i){e.enableZoom&&Le(i),e.enablePan&&Fe(i)}function pt(i){e.enableZoom&&Le(i),e.enableRotate&&ke(i)}function Oe(i){e.enabled!==!1&&(P.length===0&&(e.domElement.setPointerCapture(i.pointerId),e.domElement.addEventListener("pointermove",fe),e.domElement.addEventListener("pointerup",J)),vt(i),i.pointerType==="touch"?_e(i):gt(i))}function fe(i){e.enabled!==!1&&(i.pointerType==="touch"?bt(i):yt(i))}function J(i){switch(xt(i),P.length){case 0:e.domElement.releasePointerCapture(i.pointerId),e.domElement.removeEventListener("pointermove",fe),e.domElement.removeEventListener("pointerup",J),e.dispatchEvent(Ke),o=a.NONE;break;case 1:const m=P[0],y=F[m];_e({pointerId:m,pageX:y.x,pageY:y.y});break}}function gt(i){let m;switch(i.button){case 0:m=e.mouseButtons.LEFT;break;case 1:m=e.mouseButtons.MIDDLE;break;case 2:m=e.mouseButtons.RIGHT;break;default:m=-1}switch(m){case K.DOLLY:if(e.enableZoom===!1)return;nt(i),o=a.DOLLY;break;case K.ROTATE:if(i.ctrlKey||i.metaKey||i.shiftKey){if(e.enablePan===!1)return;Re(i),o=a.PAN}else{if(e.enableRotate===!1)return;Ee(i),o=a.ROTATE}break;case K.PAN:if(i.ctrlKey||i.metaKey||i.shiftKey){if(e.enableRotate===!1)return;Ee(i),o=a.ROTATE}else{if(e.enablePan===!1)return;Re(i),o=a.PAN}break;default:o=a.NONE}o!==a.NONE&&e.dispatchEvent(Me)}function yt(i){switch(o){case a.ROTATE:if(e.enableRotate===!1)return;rt(i);break;case a.DOLLY:if(e.enableZoom===!1)return;lt(i);break;case a.PAN:if(e.enablePan===!1)return;ct(i);break}}function Be(i){e.enabled===!1||e.enableZoom===!1||o!==a.NONE||(i.preventDefault(),e.dispatchEvent(Me),ht(wt(i)),e.dispatchEvent(Ke))}function wt(i){const m=i.deltaMode,y={clientX:i.clientX,clientY:i.clientY,deltaY:i.deltaY};switch(m){case 1:y.deltaY*=16;break;case 2:y.deltaY*=100;break}return i.ctrlKey&&!L&&(y.deltaY*=10),y}function Mt(i){i.key==="Control"&&(L=!0,e.domElement.getRootNode().addEventListener("keyup",Ie,{passive:!0,capture:!0}))}function Ie(i){i.key==="Control"&&(L=!1,e.domElement.getRootNode().removeEventListener("keyup",Ie,{passive:!0,capture:!0}))}function pe(i){e.enabled===!1||e.enablePan===!1||dt(i)}function _e(i){switch(Ne(i),P.length){case 1:switch(e.touches.ONE){case Q.ROTATE:if(e.enableRotate===!1)return;Ae(i),o=a.TOUCH_ROTATE;break;case Q.PAN:if(e.enablePan===!1)return;ze(i),o=a.TOUCH_PAN;break;default:o=a.NONE}break;case 2:switch(e.touches.TWO){case Q.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;ut(i),o=a.TOUCH_DOLLY_PAN;break;case Q.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;mt(i),o=a.TOUCH_DOLLY_ROTATE;break;default:o=a.NONE}break;default:o=a.NONE}o!==a.NONE&&e.dispatchEvent(Me)}function bt(i){switch(Ne(i),o){case a.TOUCH_ROTATE:if(e.enableRotate===!1)return;ke(i),e.update();break;case a.TOUCH_PAN:if(e.enablePan===!1)return;Fe(i),e.update();break;case a.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;ft(i),e.update();break;case a.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;pt(i),e.update();break;default:o=a.NONE}}function Ue(i){e.enabled!==!1&&i.preventDefault()}function vt(i){P.push(i.pointerId)}function xt(i){delete F[i.pointerId];for(let m=0;m<P.length;m++)if(P[m]==i.pointerId){P.splice(m,1);return}}function Ne(i){let m=F[i.pointerId];m===void 0&&(m=new x,F[i.pointerId]=m),m.set(i.pageX,i.pageY)}function q(i){const m=i.pointerId===P[0]?P[1]:P[0];return F[m]}e.domElement.addEventListener("contextmenu",Ue),e.domElement.addEventListener("pointerdown",Oe),e.domElement.addEventListener("pointercancel",J),e.domElement.addEventListener("wheel",Be,{passive:!1}),e.domElement.getRootNode().addEventListener("keydown",Mt,{passive:!0,capture:!0}),this.update()}}class os{constructor(t,s,e){c(this,"position");c(this,"velocity");c(this,"acceleration");c(this,"maxSpeed");c(this,"maxForce");this.position=new f(t,s,e),this.velocity=new f((Math.random()-.5)*.2,(Math.random()-.5)*.2,(Math.random()-.5)*.2),this.acceleration=new f,this.maxSpeed=.08+Math.random()*.06,this.maxForce=.004+Math.random()*.003}applyForce(t){this.acceleration.add(t)}seek(t){const s=new f().subVectors(t,this.position);s.normalize(),s.multiplyScalar(this.maxSpeed);const e=new f().subVectors(s,this.velocity);return e.clampLength(0,this.maxForce),e}flee(t){const s=new f().subVectors(this.position,t);s.normalize(),s.multiplyScalar(this.maxSpeed);const e=new f().subVectors(s,this.velocity);return e.clampLength(0,this.maxForce),e}update(){this.velocity.add(this.acceleration),this.velocity.clampLength(0,this.maxSpeed),this.position.add(this.velocity),this.acceleration.multiplyScalar(0)}}class ns{constructor(t,s){c(this,"boids");c(this,"params");c(this,"bounds");this.boids=[],this.bounds=s,this.params={alignment:.4,cohesion:.08,separation:1.5,maxSpeed:.12,maxForce:.006,neighborRadius:3};const e=new f;s.getSize(e);const a=new f;s.getCenter(a);for(let o=0;o<t;o++){const n=a.x+(Math.random()-.5)*e.x*.8,r=a.y+(Math.random()-.5)*e.y*.8,l=a.z+(Math.random()-.5)*e.z*.8,h=new os(n,r,l);h.maxSpeed=this.params.maxSpeed,h.maxForce=this.params.maxForce,this.boids.push(h)}}alignment(t,s){const e=new f;if(s.length===0)return e;for(const o of s)e.add(o.velocity);e.divideScalar(s.length),e.normalize(),e.multiplyScalar(t.maxSpeed);const a=new f().subVectors(e,t.velocity);return a.clampLength(0,t.maxForce),a}cohesion(t,s){const e=new f;if(s.length===0)return e;for(const a of s)e.add(a.position);return e.divideScalar(s.length),t.seek(e)}separation(t,s){const e=new f;for(const a of s){const o=t.position.distanceTo(a.position);if(o>0&&o<1){const n=new f().subVectors(t.position,a.position);n.normalize(),n.divideScalar(o),e.add(n)}}return s.length>0&&e.divideScalar(s.length),e.length()>0&&(e.normalize(),e.multiplyScalar(t.maxSpeed),e.sub(t.velocity),e.clampLength(0,t.maxForce)),e}boundaries(t){const s=new f,e=2,a=2,o=t.position.x-this.bounds.min.x,n=this.bounds.max.x-t.position.x,r=t.position.y-this.bounds.min.y,l=this.bounds.max.y-t.position.y,h=t.position.z-this.bounds.min.z,d=this.bounds.max.z-t.position.z;if(o<e){const u=(e-o)/e;s.x+=a*u}if(n<e){const u=(e-n)/e;s.x-=a*u}if(r<e){const u=(e-r)/e;s.y+=a*u}if(l<e){const u=(e-l)/e;s.y-=a*u}if(h<e){const u=(e-h)/e;s.z+=a*u}if(d<e){const u=(e-d)/e;s.z-=a*u}return s}getNeighbors(t){const s=[];for(const e of this.boids)e!==t&&t.position.distanceTo(e.position)<this.params.neighborRadius&&s.push(e);return s}setSeparation(t){this.params.separation=t}setAlignment(t){this.params.alignment=t}setCohesion(t){this.params.cohesion=t}update(){for(const t of this.boids){const s=this.getNeighbors(t),e=this.alignment(t,s),a=this.cohesion(t,s),o=this.separation(t,s),n=this.boundaries(t);e.multiplyScalar(this.params.alignment),a.multiplyScalar(this.params.cohesion),o.multiplyScalar(this.params.separation),n.multiplyScalar(1.5),t.applyForce(e),t.applyForce(a),t.applyForce(o),t.applyForce(n),t.update()}}}class rs{constructor(t,s){c(this,"group");c(this,"instancedMeshes",[]);c(this,"boids");c(this,"fishCount");c(this,"dummy",new zt);c(this,"variants");c(this,"randomOffsets",new Float32Array);c(this,"swimPhases",new Float32Array);c(this,"speedMultipliers",new Float32Array);c(this,"wanderTargets",[]);c(this,"lastWanderUpdate",0);this.group=new V,t.add(this.group);const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);this.fishCount=e?25:60,this.variants=this.createFishVariants(),this.boids=new ns(this.fishCount,s),this.initializeRandomness(),this.createDetailedFishMeshes()}createFishVariants(){return[{name:"Tropical",primaryColor:new S(16739125),secondaryColor:new S(16766720),scale:.5,speed:1},{name:"Angelfish",primaryColor:new S(8900331),secondaryColor:new S(4286945),scale:.65,speed:.8},{name:"Neon",primaryColor:new S(65535),secondaryColor:new S(16716947),scale:.35,speed:1.5},{name:"Goldfish",primaryColor:new S(16766720),secondaryColor:new S(16747520),scale:.55,speed:.9}]}initializeRandomness(){this.randomOffsets=new Float32Array(this.fishCount),this.swimPhases=new Float32Array(this.fishCount),this.speedMultipliers=new Float32Array(this.fishCount),this.wanderTargets=[];for(let t=0;t<this.fishCount;t++)this.randomOffsets[t]=Math.random()*Math.PI*2,this.swimPhases[t]=Math.random()*Math.PI*2,this.speedMultipliers[t]=.3+Math.random()*.4,this.wanderTargets.push(new f((Math.random()-.5)*20,(Math.random()-.5)*14,(Math.random()-.5)*16))}updateWanderTargets(t){var s;if(t-this.lastWanderUpdate>5e3+Math.random()*7e3){this.lastWanderUpdate=t;const e=Math.floor(this.fishCount*.2);for(let a=0;a<e;a++){const o=Math.floor(Math.random()*this.fishCount),n=((s=this.boids.boids[o])==null?void 0:s.position)||new f,r=new f((Math.random()-.5)*2,(Math.random()-.5)*2,(Math.random()-.5)*2).normalize(),l=n.clone().add(r.multiplyScalar(3+Math.random()*5));this.wanderTargets[o].copy(l)}}}createDetailedFishMeshes(){const t=Math.ceil(this.fishCount/this.variants.length);this.variants.forEach((s,e)=>{const a=Math.min(t,this.fishCount-e*t);if(a<=0)return;const o=this.createDetailedFishGeometry(s),n=this.createFishMaterial(s),r=new Dt(o,n,a);r.instanceMatrix.setUsage(kt),r.castShadow=!0,r.receiveShadow=!0;const l=new Float32Array(a*3);for(let h=0;h<a;h++){const d=Math.random()*.1-.05,u=.8+Math.random()*.2,g=.5+Math.random()*.3,p=new S;p.setHSL((s.primaryColor.getHSL({}).h+d)%1,u,g),l[h*3]=p.r,l[h*3+1]=p.g,l[h*3+2]=p.b}r.instanceColor=new Ft(l,3),this.instancedMeshes.push(r),this.group.add(r)})}createDetailedFishGeometry(t){const s=new Lt;s.moveTo(0,0),s.quadraticCurveTo(.4,.25,.8,.15),s.quadraticCurveTo(1.2,.08,1.5,0),s.quadraticCurveTo(1.2,-.08,.8,-.15),s.quadraticCurveTo(.4,-.25,0,0);const e={depth:.3,bevelEnabled:!0,bevelSegments:3,steps:2,bevelSize:.03,bevelThickness:.03},a=new Ot(s,e);a.center();const o=new se(.2,.6,6);o.rotateZ(Math.PI/2),o.translate(-.8,0,0);const n=new se(.08,.25,4);n.rotateZ(-Math.PI/3),n.rotateY(Math.PI/6),n.translate(.3,.15,.12),n.clone().translate(0,-.3,-.24);const l=new se(.12,.4,5);l.rotateX(Math.PI/2),l.translate(.2,.2,0);const h=new se(.06,.15,4);h.rotateX(-Math.PI/2),h.translate(.1,-.18,0);const d=new Se;return d.copy(a),d.scale(t.scale,t.scale,t.scale),d}createFishMaterial(t){const s=document.createElement("canvas");s.width=256,s.height=256;const e=s.getContext("2d"),a=e.createLinearGradient(0,0,s.width,s.height);a.addColorStop(0,t.primaryColor.getStyle()),a.addColorStop(.5,t.secondaryColor.getStyle()),a.addColorStop(1,t.primaryColor.clone().multiplyScalar(.7).getStyle()),e.fillStyle=a,e.fillRect(0,0,s.width,s.height),e.globalCompositeOperation="overlay";for(let n=0;n<s.width;n+=12)for(let r=0;r<s.height;r+=12){const l=r%24===0?6:0;e.fillStyle=`rgba(255, 255, 255, ${.1+Math.random()*.1})`,e.beginPath(),e.arc(n+l,r,4,0,Math.PI*2),e.fill()}e.globalCompositeOperation="source-over";const o=new Y(s);return o.wrapS=O,o.wrapT=O,new ae({map:o,color:16777215,metalness:.1,roughness:.3,clearcoat:.8,clearcoatRoughness:.2,reflectivity:.9,envMapIntensity:.5,transparent:!1,side:Bt})}update(t,s){this.updateWanderTargets(s),this.boids.boids.forEach((a,o)=>{if(o<this.wanderTargets.length){const n=this.wanderTargets[o].clone().sub(a.position);n.normalize().multiplyScalar(.003*this.speedMultipliers[o]);const r=new f((Math.random()-.5)*.001,(Math.random()-.5)*.001,(Math.random()-.5)*.001),l=new f(Math.sin(s*.06+this.randomOffsets[o])*.001,Math.sin(s*.05+this.randomOffsets[o]*2)*8e-4,Math.sin(s*.04+this.randomOffsets[o]*3)*.001);if(Math.random()<.001){const h=new f((Math.random()-.5)*.02,(Math.random()-.5)*.015,(Math.random()-.5)*.02);a.acceleration.add(h)}a.acceleration.add(n).add(r).add(l)}}),this.boids.update();let e=0;this.instancedMeshes.forEach((a,o)=>{const n=this.variants[o],r=a.count;for(let l=0;l<r&&e<this.boids.boids.length;l++,e++){const h=this.boids.boids[e],d=this.randomOffsets[e],u=this.swimPhases[e],g=this.speedMultipliers[e];this.dummy.position.copy(h.position);const p=h.velocity.clone().normalize();if(p.length()>0){const L=new f(Math.sin(s*.8+d)*.15+Math.sin(s*1.3+d*2)*.08,Math.sin(s*.6+d+1)*.12+Math.sin(s*1.1+d*3)*.06,Math.sin(s*.7+d+2)*.1+Math.sin(s*1.2+d*4)*.05);if(Math.random()<.008){const I=new f((Math.random()-.5)*.4,(Math.random()-.5)*.3,(Math.random()-.5)*.35);L.add(I)}p.add(L).normalize();const $=new f(-1,0,0),B=new be;B.setFromUnitVectors($,p),this.dummy.setRotationFromQuaternion(B)}const w=n.speed*g*(2+Math.sin(d)*1),M=Math.sin(s*w+u)*(.03+Math.sin(d*2)*.02);this.dummy.rotation.z+=M;const T=w*(1.8+Math.sin(d*3)*.4),C=Math.sin(s*T+u*1.5)*(.08+Math.sin(d*4)*.04);this.dummy.rotation.y+=C;const A=h.velocity.length(),R=.5+Math.sin(d*5)*.3;this.dummy.rotation.x+=A*R*.8;const z=Math.sin(s*.8+d)*.015*g;this.dummy.position.y+=z;const D=Math.sin(s*.6+d*2)*.008*g;this.dummy.position.x+=D;const G=.4+Math.sin(d*6)*.2,P=Math.sin(s*G+u)*.015+1,F=n.scale*P*(.98+Math.sin(d*7)*.04);if(this.dummy.scale.set(F,F,F),Math.random()<2e-4){const L=(Math.random()-.5)*.1;this.dummy.rotation.y+=L}this.dummy.updateMatrix(),a.setMatrixAt(l,this.dummy.matrix)}a.instanceMatrix.needsUpdate=!0})}setMotionEnabled(t){if(!t)for(const s of this.boids.boids)s.velocity.multiplyScalar(0),s.acceleration.multiplyScalar(0)}}class ls{constructor(t,s){c(this,"group");c(this,"bubbleSystem");this.group=new V,t.add(this.group),this.bubbleSystem=this.createBubbleSystem(s),this.group.add(this.bubbleSystem.points)}createBubbleSystem(t){const e=new Se,a=new Float32Array(40*3),o=new Float32Array(40),n=new Float32Array(40),r=new Float32Array(40),l=new Float32Array(40),h=new Float32Array(40),d=new f;t.getSize(d);const u=new f;t.getCenter(u);for(let p=0;p<40;p++)a[p*3]=u.x+(Math.random()-.5)*d.x*.9,a[p*3+1]=t.min.y+Math.random()*1,a[p*3+2]=u.z+(Math.random()-.5)*d.z*.9,o[p]=Math.random()*.8+.3,n[p]=Math.random()*.3+.15,r[p]=Math.random()*20,l[p]=Math.random()*Math.PI*2,h[p]=a[p*3+1];e.setAttribute("position",new X(a,3)),e.setAttribute("size",new X(o,1)),e.setAttribute("speed",new X(n,1)),e.setAttribute("offset",new X(r,1)),e.setAttribute("phase",new X(l,1)),e.setAttribute("startY",new X(h,1));const g=new H({uniforms:{time:{value:0},color:{value:new S(.9,.95,1)},tankBounds:{value:new It(t.min.y,t.max.y,0,0)}},vertexShader:`
        attribute float size;
        attribute float speed;
        attribute float offset;
        attribute float phase;
        attribute float startY;
        
        varying float vAlpha;
        varying float vSize;
        
        uniform float time;
        uniform vec4 tankBounds; // min.y, max.y
        
        void main() {
          vec3 pos = position;
          
          float totalTime = time * speed + offset;
          float travelDistance = tankBounds.y - tankBounds.x; // 水槽の高さ
          
          // 底から天井まで連続的に移動
          float progress = mod(totalTime * 0.5, 1.0);
          pos.y = tankBounds.x + progress * travelDistance;
          
          // 泡が上昇するにつれて左右に揺れる
          float wiggle = sin(progress * 10.0 + phase) * 0.1 * progress;
          pos.x += wiggle;
          pos.z += cos(progress * 8.0 + phase) * 0.08 * progress;
          
          vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
          gl_Position = projectionMatrix * mvPosition;
          
          vSize = size;
          gl_PointSize = size * (300.0 / -mvPosition.z);
          
          // 全体的に透明感を高める
          vAlpha = (1.0 - smoothstep(0.8, 1.0, progress)) * 0.4;  // 基本透明度を下げる
          vAlpha *= (0.6 + 0.2 * sin(time * 2.0 + phase));  // より微妙な変化
        }
      `,fragmentShader:`
        varying float vAlpha;
        varying float vSize;
        uniform vec3 color;
        
        void main() {
          vec2 center = gl_PointCoord - vec2(0.5);
          float dist = length(center);
          
          if (dist > 0.5) discard;
          
          // よりソフトで透明感のある泡
          float alpha = smoothstep(0.5, 0.1, dist) * vAlpha * 0.3;  // 透明度をさらに下げる
          
          // より控えめなハイライト
          float highlight = smoothstep(0.4, 0.15, dist);
          vec3 finalColor = color + vec3(highlight * 0.2);  // ハイライトを控えめに
          
          gl_FragColor = vec4(finalColor, alpha);
        }
      `,transparent:!0,blending:Ze,depthWrite:!1});return{points:new _t(e,g),material:g,count:40}}update(t){this.bubbleSystem.material.uniforms.time.value=t}setEnabled(t){this.group.visible=t}}class cs{constructor(t){c(this,"scene");c(this,"envMap",null);this.scene=t}async loadHDRI(){const t=this.createEnvironmentCubeMap();return this.envMap=t,this.scene.environment=t,this.scene.background=this.createGradientBackground(),t}createEnvironmentCubeMap(){const s=document.createElement("canvas");s.width=512,s.height=512;const e=s.getContext("2d"),a=[];for(let r=0;r<6;r++){const l=e.createRadialGradient(256,256,0,256,256,256);r===2?(l.addColorStop(0,"#ffffff"),l.addColorStop(.3,"#e6f2ff"),l.addColorStop(1,"#b3d9ff")):r===3?(l.addColorStop(0,"#2c3e50"),l.addColorStop(1,"#1a252f")):(l.addColorStop(0,"#34495e"),l.addColorStop(.5,"#2c3e50"),l.addColorStop(1,"#1a252f")),e.fillStyle=l,e.fillRect(0,0,512,512),e.globalCompositeOperation="screen",e.fillStyle=`rgba(106, 199, 214, ${.1+Math.random()*.1})`;for(let h=0;h<20;h++){const d=Math.random()*512,u=Math.random()*512,g=Math.random()*30+10;e.beginPath(),e.arc(d,u,g,0,Math.PI*2),e.fill()}e.globalCompositeOperation="source-over",a.push(s.toDataURL())}const n=new Ut().load(a);return n.mapping=Nt,n}createGradientBackground(){const t=document.createElement("canvas");t.width=512,t.height=512;const s=t.getContext("2d"),e=s.createLinearGradient(0,0,0,t.height);e.addColorStop(0,"#1a4d61"),e.addColorStop(.3,"#2a5f75"),e.addColorStop(.7,"#1e3a47"),e.addColorStop(1,"#0a2e3d"),s.fillStyle=e,s.fillRect(0,0,t.width,t.height);const a=new Y(t);return a.mapping=$e,a}getEnvironmentMap(){return this.envMap}}class hs{constructor(t,s){c(this,"group");c(this,"plants",[]);c(this,"decorations",[]);c(this,"time",0);this.group=new V,t.add(this.group),this.createSeaweed(s),this.createCorals(s),this.createRocks(s),this.createSandDetails(s)}createSeaweed(t){const e=new f;t.getSize(e);for(let a=0;a<15;a++){const o=new V,n=(Math.random()-.5)*e.x*.7,r=(Math.random()-.5)*e.z*.7,l=t.min.y+.42;o.position.set(n,l,r);const h=2+Math.random()*3,d=Math.floor(h*3);for(let u=0;u<d;u++){const g=h/d,p=.1+(d-u)*.02,w=new ve(p*.3,p,g,6),M=.3+Math.random()*.2,T=this.createSeaweedTexture(M),C=this.createSeaweedNormalMap(),A=this.createSeaweedRoughnessMap(),R=new ae({map:T,normalMap:C,roughnessMap:A,color:new S().setHSL(M,.8,.4),metalness:0,roughness:.9,transmission:.4,thickness:.15,transparent:!0,opacity:.85,side:Je,envMapIntensity:.3,clearcoat:.1,clearcoatRoughness:.8}),z=new N(w,R);z.position.y=u*g+g/2,z.rotation.z=Math.sin(u*.5)*.2,z.userData={originalRotation:z.rotation.z,swayOffset:Math.random()*Math.PI*2,swayAmplitude:.1+Math.random()*.1},o.add(z)}this.plants.push(o),this.group.add(o)}}createCorals(t){const e=new f;t.getSize(e);for(let a=0;a<8;a++){const o=new V,n=(Math.random()-.5)*e.x*.6,r=(Math.random()-.5)*e.z*.6,l=t.min.y+.42;o.position.set(n,l,r);const h=3+Math.floor(Math.random()*4);for(let d=0;d<h;d++){const u=.5+Math.random()*1.5,g=.05+Math.random()*.03,p=new se(g*2,u,6),w=[new S(16739143),new S(16747625),new S(16753920),new S(16738740)],M=new ae({color:w[Math.floor(Math.random()*w.length)],metalness:0,roughness:.9,clearcoat:.3,clearcoatRoughness:.8}),T=new N(p,M);T.position.y=u/2,T.rotation.x=(Math.random()-.5)*.5,T.rotation.z=(Math.random()-.5)*.5,T.rotation.y=d/h*Math.PI*2+Math.random()*.5,o.add(T)}this.decorations.push(o),this.group.add(o)}}createRocks(t){const e=new f;t.getSize(e);for(let a=0;a<12;a++){const o=.3+Math.random()*.8,n=new Gt(o),r=n.getAttribute("position");for(let p=0;p<r.count;p++){const w=new f;w.fromBufferAttribute(r,p);const M=(Math.random()-.5)*.3;w.multiplyScalar(1+M),r.setXYZ(p,w.x,w.y,w.z)}n.computeVertexNormals();const l=new ae({color:new S().setHSL(.1+Math.random()*.1,.2+Math.random()*.3,.2+Math.random()*.3),metalness:.1,roughness:.9,bumpScale:.5}),h=new N(n,l),d=(Math.random()-.5)*e.x*.8,u=(Math.random()-.5)*e.z*.8,g=t.min.y+.42+o*.1;h.position.set(d,g,u),h.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI),h.receiveShadow=!0,this.decorations.push(new V().add(h)),this.group.add(h)}}createSandDetails(t){const s=new jt(1,.1,10,1),e=new ae({color:15259064,metalness:0,roughness:1,transparent:!0,opacity:.3});for(let a=0;a<20;a++){const o=new N(s,e);o.rotation.x=-Math.PI/2,o.rotation.z=Math.random()*Math.PI;const n=new f;t.getSize(n),o.position.set((Math.random()-.5)*n.x*.9,t.min.y+.01,(Math.random()-.5)*n.z*.9);const r=.5+Math.random()*2;o.scale.set(r,1,r),this.group.add(o)}}update(t){this.time=t,this.plants.forEach(s=>{s.children.forEach((e,a)=>{if(e.userData.originalRotation!==void 0){const o=e.userData.swayOffset||0,n=e.userData.swayAmplitude||.1,r=Math.sin(this.time*.8+o+a*.3)*n;e.rotation.z=e.userData.originalRotation+r,e.rotation.x=Math.sin(this.time*.5+o)*.05}})})}createSeaweedTexture(t){const s=document.createElement("canvas");s.width=256,s.height=512;const e=s.getContext("2d"),a=new S().setHSL(t,.7,.3),o=new S().setHSL(t,.8,.15),n=new S().setHSL(t,.6,.5),r=e.createLinearGradient(0,0,0,s.height);r.addColorStop(0,n.getStyle()),r.addColorStop(.3,a.getStyle()),r.addColorStop(.7,a.getStyle()),r.addColorStop(1,o.getStyle()),e.fillStyle=r,e.fillRect(0,0,s.width,s.height),e.globalCompositeOperation="overlay";for(let h=0;h<8;h++){const d=h/7*s.width+Math.sin(h)*20;e.strokeStyle=`rgba(0, 100, 0, ${.3+Math.random()*.2})`,e.lineWidth=2+Math.random()*3,e.beginPath(),e.moveTo(d,0);for(let u=0;u<=s.height;u+=10){const g=Math.sin(u*.02+h)*15;e.lineTo(d+g,u)}e.stroke()}e.globalCompositeOperation="multiply";for(let h=0;h<200;h++){const d=Math.random()*s.width,u=Math.random()*s.height,g=Math.random()*3,p=.1+Math.random()*.2;e.fillStyle=`rgba(0, 80, 0, ${p})`,e.fillRect(d,u,g,g)}e.globalCompositeOperation="source-over";const l=new Y(s);return l.wrapS=O,l.wrapT=O,l.repeat.set(1,2),l}createSeaweedNormalMap(){const t=document.createElement("canvas");t.width=256,t.height=512;const s=t.getContext("2d");s.fillStyle="#8080ff",s.fillRect(0,0,t.width,t.height);for(let a=0;a<8;a++){const o=a/7*t.width;s.strokeStyle="#6060ff",s.lineWidth=3,s.beginPath(),s.moveTo(o,0);for(let n=0;n<=t.height;n+=5){const r=Math.sin(n*.02+a)*10;s.lineTo(o+r,n)}s.stroke()}for(let a=0;a<150;a++){const o=Math.random()*t.width,n=Math.random()*t.height,r=1+Math.random()*2;s.fillStyle=Math.random()>.5?"#9090ff":"#7070ff",s.fillRect(o,n,r,r)}const e=new Y(t);return e.wrapS=O,e.wrapT=O,e.repeat.set(1,2),e}createSeaweedRoughnessMap(){const t=document.createElement("canvas");t.width=256,t.height=512;const s=t.getContext("2d");s.fillStyle="#808080",s.fillRect(0,0,t.width,t.height);for(let a=0;a<300;a++){const o=Math.random()*t.width,n=Math.random()*t.height,r=Math.random()*4,l=Math.random()*255;s.fillStyle=`rgb(${l}, ${l}, ${l})`,s.fillRect(o,n,r,r)}for(let a=0;a<8;a++){const o=a/7*t.width;s.strokeStyle="#404040",s.lineWidth=2,s.beginPath(),s.moveTo(o,0);for(let n=0;n<=t.height;n+=5){const r=Math.sin(n*.02+a)*10;s.lineTo(o+r,n)}s.stroke()}const e=new Y(t);return e.wrapS=O,e.wrapT=O,e.repeat.set(1,2),e}setMotionEnabled(t){this.plants.forEach(s=>{s.children.forEach(e=>{!t&&e.userData.originalRotation!==void 0&&(e.rotation.z=e.userData.originalRotation,e.rotation.x=0)})})}}class ds{constructor(t){c(this,"shells",[]);c(this,"corals",[]);c(this,"lightBeams",[]);c(this,"scene");this.scene=t,this.generateDecorations()}generateDecorations(){}update(t){const s=performance.now()*.001;this.lightBeams.forEach((e,a)=>{const o=a*1.2,n=e.material,r=.02,l=Math.sin(s*.5+o)*.01;n.opacity=Math.max(.005,r+l);const h=Math.sin(s*.3+o)*.02;e.rotation.z+=h*t;const d=Math.sin(s*.2+o*.8)*.01;e.rotation.y+=d*t}),this.shells.forEach((e,a)=>{const o=a*.5;e.rotation.y+=t*.03,e.position.y+=Math.sin(s+o)*.001}),this.corals.forEach((e,a)=>{const o=a*.7;e.rotation.y+=t*.02,e.children.forEach((n,r)=>{const l=o+r*.3;n.rotation.z=Math.sin(s*.3+l)*.05})})}dispose(){this.lightBeams.forEach(t=>{this.scene.remove(t),t.geometry.dispose(),t.material.dispose()}),this.shells.forEach(t=>{this.scene.remove(t),t.geometry.dispose(),t.material.dispose()}),this.corals.forEach(t=>{this.scene.remove(t),t.children.forEach(s=>{s.geometry.dispose(),s.material.dispose()})}),this.lightBeams=[],this.shells=[],this.corals=[]}}const tt={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class oe{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const us=new Vt(-1,1,1,-1,0,1);class ms extends Se{constructor(){super(),this.setAttribute("position",new Ve([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Ve([0,2,0,0,2,0],2))}}const fs=new ms;class st{constructor(t){this._mesh=new N(fs,t)}dispose(){this._mesh.geometry.dispose()}render(t){t.render(this._mesh,us)}get material(){return this._mesh.material}set material(t){this._mesh.material=t}}class at extends oe{constructor(t,s){super(),this.textureID=s!==void 0?s:"tDiffuse",t instanceof H?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=xe.clone(t.uniforms),this.material=new H({name:t.name!==void 0?t.name:"unspecified",defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new st(this.material)}render(t,s,e){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=e.texture),this.fsQuad.material=this.material,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(s),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class Xe extends oe{constructor(t,s){super(),this.scene=t,this.camera=s,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(t,s,e){const a=t.getContext(),o=t.state;o.buffers.color.setMask(!1),o.buffers.depth.setMask(!1),o.buffers.color.setLocked(!0),o.buffers.depth.setLocked(!0);let n,r;this.inverse?(n=0,r=1):(n=1,r=0),o.buffers.stencil.setTest(!0),o.buffers.stencil.setOp(a.REPLACE,a.REPLACE,a.REPLACE),o.buffers.stencil.setFunc(a.ALWAYS,n,4294967295),o.buffers.stencil.setClear(r),o.buffers.stencil.setLocked(!0),t.setRenderTarget(e),this.clear&&t.clear(),t.render(this.scene,this.camera),t.setRenderTarget(s),this.clear&&t.clear(),t.render(this.scene,this.camera),o.buffers.color.setLocked(!1),o.buffers.depth.setLocked(!1),o.buffers.color.setMask(!0),o.buffers.depth.setMask(!0),o.buffers.stencil.setLocked(!1),o.buffers.stencil.setFunc(a.EQUAL,1,4294967295),o.buffers.stencil.setOp(a.KEEP,a.KEEP,a.KEEP),o.buffers.stencil.setLocked(!0)}}class ps extends oe{constructor(){super(),this.needsSwap=!1}render(t){t.state.buffers.stencil.setLocked(!1),t.state.buffers.stencil.setTest(!1)}}class it{constructor(t,s){if(this.renderer=t,this._pixelRatio=t.getPixelRatio(),s===void 0){const e=t.getSize(new x);this._width=e.width,this._height=e.height,s=new ie(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:he}),s.texture.name="EffectComposer.rt1"}else this._width=s.width,this._height=s.height;this.renderTarget1=s,this.renderTarget2=s.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new at(tt),this.copyPass.material.blending=Ht,this.clock=new et}swapBuffers(){const t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t}addPass(t){this.passes.push(t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(t,s){this.passes.splice(s,0,t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(t){const s=this.passes.indexOf(t);s!==-1&&this.passes.splice(s,1)}isLastEnabledPass(t){for(let s=t+1;s<this.passes.length;s++)if(this.passes[s].enabled)return!1;return!0}render(t){t===void 0&&(t=this.clock.getDelta());const s=this.renderer.getRenderTarget();let e=!1;for(let a=0,o=this.passes.length;a<o;a++){const n=this.passes[a];if(n.enabled!==!1){if(n.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(a),n.render(this.renderer,this.writeBuffer,this.readBuffer,t,e),n.needsSwap){if(e){const r=this.renderer.getContext(),l=this.renderer.state.buffers.stencil;l.setFunc(r.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),l.setFunc(r.EQUAL,1,4294967295)}this.swapBuffers()}Xe!==void 0&&(n instanceof Xe?e=!0:n instanceof ps&&(e=!1))}}this.renderer.setRenderTarget(s)}reset(t){if(t===void 0){const s=this.renderer.getSize(new x);this._pixelRatio=this.renderer.getPixelRatio(),this._width=s.width,this._height=s.height,t=this.renderTarget1.clone(),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(t,s){this._width=t,this._height=s;const e=this._width*this._pixelRatio,a=this._height*this._pixelRatio;this.renderTarget1.setSize(e,a),this.renderTarget2.setSize(e,a);for(let o=0;o<this.passes.length;o++)this.passes[o].setSize(e,a)}setPixelRatio(t){this._pixelRatio=t,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class ot extends oe{constructor(t,s,e=null,a=null,o=null){super(),this.scene=t,this.camera=s,this.overrideMaterial=e,this.clearColor=a,this.clearAlpha=o,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new S}render(t,s,e){const a=t.autoClear;t.autoClear=!1;let o,n;this.overrideMaterial!==null&&(n=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(t.getClearColor(this._oldClearColor),t.setClearColor(this.clearColor)),this.clearAlpha!==null&&(o=t.getClearAlpha(),t.setClearAlpha(this.clearAlpha)),this.clearDepth==!0&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:e),this.clear===!0&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),this.clearColor!==null&&t.setClearColor(this._oldClearColor),this.clearAlpha!==null&&t.setClearAlpha(o),this.overrideMaterial!==null&&(this.scene.overrideMaterial=n),t.autoClear=a}}const gs={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new S(0)},defaultOpacity:{value:0}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec3 defaultColor;
		uniform float defaultOpacity;
		uniform float luminosityThreshold;
		uniform float smoothWidth;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );

			vec3 luma = vec3( 0.299, 0.587, 0.114 );

			float v = dot( texel.xyz, luma );

			vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

			float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

			gl_FragColor = mix( outputColor, texel, alpha );

		}`};class Z extends oe{constructor(t,s,e,a){super(),this.strength=s!==void 0?s:1,this.radius=e,this.threshold=a,this.resolution=t!==void 0?new x(t.x,t.y):new x(256,256),this.clearColor=new S(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let o=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);this.renderTargetBright=new ie(o,n,{type:he}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let u=0;u<this.nMips;u++){const g=new ie(o,n,{type:he});g.texture.name="UnrealBloomPass.h"+u,g.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(g);const p=new ie(o,n,{type:he});p.texture.name="UnrealBloomPass.v"+u,p.texture.generateMipmaps=!1,this.renderTargetsVertical.push(p),o=Math.round(o/2),n=Math.round(n/2)}const r=gs;this.highPassUniforms=xe.clone(r.uniforms),this.highPassUniforms.luminosityThreshold.value=a,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new H({uniforms:this.highPassUniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.separableBlurMaterials=[];const l=[3,5,7,9,11];o=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);for(let u=0;u<this.nMips;u++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(l[u])),this.separableBlurMaterials[u].uniforms.invSize.value=new x(1/o,1/n),o=Math.round(o/2),n=Math.round(n/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=s,this.compositeMaterial.uniforms.bloomRadius.value=.1;const h=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=h,this.bloomTintColors=[new f(1,1,1),new f(1,1,1),new f(1,1,1),new f(1,1,1),new f(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const d=tt;this.copyUniforms=xe.clone(d.uniforms),this.blendMaterial=new H({uniforms:this.copyUniforms,vertexShader:d.vertexShader,fragmentShader:d.fragmentShader,blending:Ze,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new S,this.oldClearAlpha=1,this.basic=new Yt,this.fsQuad=new st(null)}dispose(){for(let t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(let t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose();for(let t=0;t<this.separableBlurMaterials.length;t++)this.separableBlurMaterials[t].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(t,s){let e=Math.round(t/2),a=Math.round(s/2);this.renderTargetBright.setSize(e,a);for(let o=0;o<this.nMips;o++)this.renderTargetsHorizontal[o].setSize(e,a),this.renderTargetsVertical[o].setSize(e,a),this.separableBlurMaterials[o].uniforms.invSize.value=new x(1/e,1/a),e=Math.round(e/2),a=Math.round(a/2)}render(t,s,e,a,o){t.getClearColor(this._oldClearColor),this.oldClearAlpha=t.getClearAlpha();const n=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),o&&t.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=e.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=e.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);let r=this.renderTargetBright;for(let l=0;l<this.nMips;l++)this.fsQuad.material=this.separableBlurMaterials[l],this.separableBlurMaterials[l].uniforms.colorTexture.value=r.texture,this.separableBlurMaterials[l].uniforms.direction.value=Z.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[l]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[l].uniforms.colorTexture.value=this.renderTargetsHorizontal[l].texture,this.separableBlurMaterials[l].uniforms.direction.value=Z.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[l]),t.clear(),this.fsQuad.render(t),r=this.renderTargetsVertical[l];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,o&&t.state.buffers.stencil.setTest(!0),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.fsQuad.render(t)),t.setClearColor(this._oldClearColor,this.oldClearAlpha),t.autoClear=n}getSeperableBlurMaterial(t){const s=[];for(let e=0;e<t;e++)s.push(.39894*Math.exp(-.5*e*e/(t*t))/t);return new H({defines:{KERNEL_RADIUS:t},uniforms:{colorTexture:{value:null},invSize:{value:new x(.5,.5)},direction:{value:new x(.5,.5)},gaussianCoefficients:{value:s}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 invSize;
				uniform vec2 direction;
				uniform float gaussianCoefficients[KERNEL_RADIUS];

				void main() {
					float weightSum = gaussianCoefficients[0];
					vec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianCoefficients[i];
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(t){return new H({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}}Z.BlurDirectionX=new x(1,0);Z.BlurDirectionY=new x(0,1);const ys={uniforms:{tDiffuse:{value:null},opacity:{value:.25},sunPosition:{value:new x(.5,0)}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float opacity;
    varying vec2 vUv;
    
    uniform vec2 sunPosition;
    
    void main() {
      vec4 color = texture2D(tDiffuse, vUv);
      
      // Use sun position even if outside screen bounds
      vec2 center = sunPosition;
      
      // Use sun position directly for ray calculation
      vec2 rayCenter = center;
      
      // If sun is off-screen, reduce the effect intensity but keep direction
      float offScreenFactor = 1.0;
      if (center.x < 0.0 || center.x > 1.0 || center.y < 0.0 || center.y > 1.0) {
        offScreenFactor = 0.3;  // Reduce intensity when sun is off-screen
      }
      
      float dist = distance(vUv, rayCenter);
      
      // 太陽から画面全体への方向ベクトル
      vec2 sunToPixel = vUv - rayCenter;
      float distToSun = length(sunToPixel);
      vec2 rayDirection = normalize(sunToPixel);
      
      // 長い光線エフェクト（距離制限なし）
      float longRay = 0.0;
      
      // 太陽方向からの放射状光線（不規則な幅）
      float angle = atan(rayDirection.y, rayDirection.x);
      
      // 複数の周波数を組み合わせて不規則なパターンを作成
      float rayPattern1 = sin(angle * 8.0) * 0.5 + 0.5;  // 基本の8本
      float rayPattern2 = sin(angle * 5.0 + 1.57) * 0.3;  // 5本（位相シフト）
      float rayPattern3 = sin(angle * 11.0 - 0.78) * 0.2;  // 11本（位相シフト）
      
      // ノイズのような変化を追加
      float noisePattern = sin(angle * 23.0) * sin(angle * 17.0) * 0.15;
      
      // パターンを組み合わせて不規則な幅を作成
      float rayPattern = rayPattern1 + rayPattern2 + rayPattern3 + noisePattern;
      rayPattern = clamp(rayPattern, 0.0, 1.0);
      
      // 場所によって異なる鋭さを適用
      float sharpness = 2.0 + sin(angle * 3.0) * 1.5;
      rayPattern = pow(rayPattern, sharpness);  // 不規則な鋭さ
      
      // 距離による減衰（より緩やか）
      float distanceFade = 1.0 / (1.0 + distToSun * 0.5);
      
      // 主要な光線ストリーク
      float mainBeam = rayPattern * distanceFade;
      
      // 縦方向の光線（太陽が上にある時）- 不規則な幅
      float verticalBeam = 0.0;
      if (rayCenter.y <= 1.0) {  // 太陽の高度制限を緩和
        float horizontalDist = abs(vUv.x - rayCenter.x);
        
        // 高さに応じた幅の変化を追加
        float heightVariation = 1.0 + sin(vUv.y * 15.0) * 0.3 + sin(vUv.y * 7.0) * 0.2;
        float widthFactor = 8.0 * heightVariation;
        
        // 複数の光線を重ねて不規則感を出す
        float beam1 = exp(-horizontalDist * widthFactor);
        float beam2 = exp(-horizontalDist * (widthFactor * 0.6)) * 0.5;  // より幅広の薄い光線
        float beam3 = exp(-horizontalDist * (widthFactor * 1.5)) * 0.3;  // より細い光線
        
        verticalBeam = beam1 + beam2 + beam3;
        verticalBeam *= smoothstep(min(rayCenter.y, 0.0), 1.0, vUv.y);  // 上から下へ
        
        // 局所的な強度変化を追加
        verticalBeam *= 0.7 + sin(vUv.y * 40.0 + vUv.x * 10.0) * 0.3;
      }
      
      // 画面外でも見える長い光線
      float screenRay = 0.0;
      if (rayCenter.x < 0.0 || rayCenter.x > 1.0 || rayCenter.y < 0.0 || rayCenter.y > 1.0) {
        // 画面外の太陽からの光線
        vec2 screenCenter = vec2(0.5, 0.5);
        vec2 sunDirection = normalize(rayCenter - screenCenter);
        
        // 太陽方向に基づく光線強度
        float alignment = max(0.0, dot(rayDirection, sunDirection));
        screenRay = pow(alignment, 4.0) * 0.4;  // 太陽方向に向かう光線
      }
      
      // 複数の光線を組み合わせ
      float combinedRay = (mainBeam * 0.4 + verticalBeam * 0.5 + screenRay) * offScreenFactor;
      
      vec3 rayColor = vec3(1.0, 0.95, 0.8) * combinedRay * opacity;
      
      gl_FragColor = vec4(color.rgb + rayColor, 1.0);
    }
  `};class ws{constructor(t,s,e){c(this,"composer");c(this,"godRaysPass");c(this,"bloomPass");c(this,"depthMaterial");c(this,"depthRenderTarget");c(this,"scene");c(this,"camera");c(this,"renderer");c(this,"sunMesh");this.renderer=t,this.scene=s,this.camera=e;const a=t.getSize(new x);this.depthRenderTarget=new ie(a.width*.5,a.height*.5,{minFilter:He,magFilter:He,format:Wt}),this.depthMaterial=new qt,this.composer=new it(t);const o=new ot(s,e);this.composer.addPass(o),this.bloomPass=new Z(new x(a.width,a.height),.3,.2,.8),this.composer.addPass(this.bloomPass),this.godRaysPass=new at(ys),this.composer.addPass(this.godRaysPass);const n=new V;this.sunMesh=n,this.sunMesh.position.set(0,15,0),this.setUnderwaterParameters()}setUnderwaterParameters(){this.godRaysPass.uniforms.opacity.value=.2}renderDepth(){const t=new Map;this.scene.traverse(s=>{s instanceof N&&(t.set(s,s.material),s.material=this.depthMaterial)}),this.renderer.setRenderTarget(this.depthRenderTarget),this.renderer.render(this.scene,this.camera),t.forEach((s,e)=>{e.material=s}),this.renderer.setRenderTarget(null)}update(t){this.sunMesh.position.x=Math.sin(t*.05)*1.5,this.sunMesh.position.y=15+Math.sin(t*.03)*.5,this.sunMesh.position.z=Math.cos(t*.05)*1.5;const s=new f;s.copy(this.sunMesh.position),s.project(this.camera);const e=new x((s.x+1)*.5,(s.y+1)*.5);this.godRaysPass.uniforms.sunPosition.value=e;const a=.25,o=Math.sin(t*.2)*.05;this.godRaysPass.uniforms.opacity.value=Math.max(.15,a+o)}render(){this.renderDepth(),this.composer.render()}resize(t,s){this.composer.setSize(t,s),this.bloomPass.setSize(t,s),this.depthRenderTarget.setSize(t*.5,s*.5)}dispose(){this.composer.dispose(),this.depthRenderTarget.dispose()}}class Ms{constructor(t){c(this,"scene");c(this,"camera");c(this,"renderer");c(this,"composer");c(this,"controls");c(this,"clock");c(this,"tank");c(this,"fishSystem",null);c(this,"particleSystem",null);c(this,"aquascaping",null);c(this,"spiralDecorations",null);c(this,"godRaysEffect",null);c(this,"environmentLoader");c(this,"animationId",null);c(this,"motionEnabled",!0);c(this,"advancedEffectsEnabled",!0);c(this,"stats",{fps:0,frameTime:0,fishVisible:0,drawCalls:0});c(this,"fpsCounter",0);c(this,"lastStatsUpdate",0);c(this,"animate",()=>{const t=performance.now();this.animationId=requestAnimationFrame(this.animate);const s=this.clock.getDelta(),e=this.clock.getElapsedTime();this.renderer.info.reset(),this.controls.update(),this.motionEnabled&&(this.fishSystem&&(this.fishSystem.update(s,e),this.stats.fishVisible=60),this.particleSystem&&this.particleSystem.update(e),this.aquascaping&&this.aquascaping.update(e),this.spiralDecorations&&this.spiralDecorations.update(s)),this.godRaysEffect&&this.advancedEffectsEnabled?(this.godRaysEffect.update(e),this.godRaysEffect.render()):this.renderer.render(this.scene,this.camera),this.updatePerformanceStats(t)});c(this,"handleResize",()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.composer&&this.composer.setSize(window.innerWidth,window.innerHeight),this.godRaysEffect&&this.godRaysEffect.resize(window.innerWidth,window.innerHeight)});this.scene=new Kt,this.clock=new et,this.setupCamera(),this.setupRenderer(t),this.setupComposer(),this.setupControls(),this.tank=new V,this.scene.add(this.tank),this.environmentLoader=new cs(this.scene),this.init()}setupCamera(){this.camera=new Qt(75,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,-2,12)}setupRenderer(t){this.renderer=new Xt({antialias:!0,alpha:!0,powerPreference:"high-performance"}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.toneMapping=Zt,this.renderer.toneMappingExposure=1.2,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=$t,this.renderer.outputColorSpace=Ye,this.renderer.info.autoReset=!1,t.appendChild(this.renderer.domElement)}setupComposer(){this.composer=new it(this.renderer);const t=new ot(this.scene,this.camera);this.composer.addPass(t)}setupControls(){this.controls=new is(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.02,this.controls.minDistance=1,this.controls.maxDistance=16,this.controls.maxPolarAngle=Math.PI*.95,this.controls.minPolarAngle=Math.PI*.05,this.controls.enablePan=!0,this.controls.autoRotate=!1,this.controls.autoRotateSpeed=.5,this.controls.target.set(0,0,0),this.controls.addEventListener("change",()=>{const t=this.controls.target;t.x=Math.max(-9,Math.min(9,t.x)),t.y=Math.max(-5,Math.min(2,t.y)),t.z=Math.max(-7,Math.min(7,t.z))})}async init(){await this.environmentLoader.loadHDRI(),this.setupAdvancedLighting(),this.setupGradientBackground(),this.createAdvancedTank(),this.createSpiralDecorations(),this.createAquascaping(),this.createAdvancedFishSystem(),this.createAdvancedWaterEffects(),this.setupAdvancedPostProcessing(),this.setupEventListeners()}setupAdvancedLighting(){const t=new Jt(4886712,.3);this.scene.add(t);const s=new We(16775388,1.2);s.position.set(8,15,5),s.castShadow=!0,s.shadow.camera.near=.1,s.shadow.camera.far=100,s.shadow.camera.left=-20,s.shadow.camera.right=20,s.shadow.camera.top=20,s.shadow.camera.bottom=-20,s.shadow.mapSize.width=4096,s.shadow.mapSize.height=4096,s.shadow.bias=-1e-4,this.scene.add(s);const e=new ge(4886754,.6,25);e.position.set(-8,4,-8),this.scene.add(e);const a=new ge(3066993,.4,20);a.position.set(8,4,8),this.scene.add(a);const o=new ge(3447003,.5,15);o.position.set(0,-2,0),this.scene.add(o);const n=new We(8900331,.3);n.position.set(-5,8,-10),this.scene.add(n)}setupGradientBackground(){const t=document.createElement("canvas");t.width=512,t.height=512;const s=t.getContext("2d"),e=s.createLinearGradient(0,0,0,t.height);e.addColorStop(0,"#87CEEB"),e.addColorStop(.3,"#4682B4"),e.addColorStop(.6,"#2F4F4F"),e.addColorStop(1,"#191970"),s.fillStyle=e,s.fillRect(0,0,t.width,t.height);const a=new Y(t);a.mapping=$e,a.colorSpace=Ye,this.scene.background=a,this.scene.fog=new es(4620980,10,100)}createAdvancedTank(){const o=new ts(22.2,14.2,18.2,1,1,1),n=new ye({color:2899536,metalness:.8,roughness:.2,transparent:!0,opacity:0,visible:!1}),r=new N(o,n);this.tank.add(r),this.createSubstrate(22,14,18,.12)}createSubstrate(t,s,e,a){const o=Math.min(t,e)/2+1.5,n=new ve(o,o,.3,32),r=new ye({color:16246997,roughness:.7,metalness:.05}),l=new N(n,r);l.position.y=-s/2+.25,l.receiveShadow=!0,this.tank.add(l);const h=new ve(o,o,.1,128,1,!1,0,Math.PI*2),d=h.attributes.position.array;for(let w=0;w<d.length;w+=3){const M=d[w],T=d[w+1],C=d[w+2],A=Math.sqrt(M*M+C*C);if(T>0){const R=Math.sin(M*.6)*Math.cos(C*.6)*.25,z=Math.sin(M*1.5)*Math.cos(C*1.5)*.18,D=Math.sin(M*3)*Math.cos(C*3)*.1,G=Math.sin(M*8)*Math.cos(C*8)*.03,P=(Math.random()-.5)*.12,F=(Math.random()-.5)*.06,L=(Math.random()-.5)*.03,$=Math.sin(M*1.2+Math.sin(C*.8))*Math.cos(C*1.2+Math.sin(M*.8))*.12+Math.sin(M*2.5+Math.sin(C*1.8))*Math.cos(C*2.5+Math.sin(M*1.8))*.04,B=R+z+D+G+P+F+L+$,I=(1-A/o)*.05;d[w+1]=T+B+I}}h.attributes.position.needsUpdate=!0,h.computeVertexNormals();const u=this.createSandTexture(),g=new ye({map:u,color:16246997,roughness:.8,metalness:0,transparent:!1,side:Je}),p=new N(h,g);p.position.y=-s/2+.42,p.receiveShadow=!0,p.castShadow=!1,this.tank.add(p)}createSandTexture(){const t=document.createElement("canvas");t.width=512,t.height=512;const s=t.getContext("2d");s.fillStyle="#F7E8D5",s.fillRect(0,0,t.width,t.height);for(let a=0;a<2e3;a++){const o=Math.random()*t.width,n=Math.random()*t.height,r=Math.random()*3+1,l=30+Math.random()*10,h=15+Math.random()*10,d=.85+Math.random()*.15;s.fillStyle=`hsl(${l}, ${h}%, ${d*100}%)`,s.beginPath(),s.arc(o,n,r,0,Math.PI*2),s.fill()}for(let a=0;a<300;a++){const o=Math.random()*t.width,n=Math.random()*t.height,r=Math.random()*6+2,l=25+Math.random()*15,h=10+Math.random()*15,d=.8+Math.random()*.2;s.fillStyle=`hsl(${l}, ${h}%, ${d*100}%)`,s.beginPath(),s.arc(o,n,r,0,Math.PI*2),s.fill()}const e=new Y(t);return e.wrapS=O,e.wrapT=O,e.repeat.set(4,4),e}createSpiralDecorations(){this.spiralDecorations=new ds(this.scene)}createAquascaping(){const t=new we(new f(-10.5,-6,-8.5),new f(10.5,8,8.5));this.aquascaping=new hs(this.scene,t)}createAdvancedFishSystem(){const t=new we(new f(-10.5,-6,-8.5),new f(10.5,8,8.5));this.fishSystem=new rs(this.scene,t)}createAdvancedWaterEffects(){const t=new we(new f(-10.5,-6,-8.5),new f(10.5,8,8.5));this.particleSystem=new ls(this.scene,t)}setupAdvancedPostProcessing(){this.advancedEffectsEnabled&&(this.godRaysEffect=new ws(this.renderer,this.scene,this.camera))}updatePerformanceStats(t){this.stats.frameTime=performance.now()-t,this.stats.drawCalls=this.renderer.info.render.calls,this.fpsCounter++,performance.now()-this.lastStatsUpdate>1e3&&(this.stats.fps=this.fpsCounter,this.fpsCounter=0,this.lastStatsUpdate=performance.now())}start(){this.animate()}stop(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}setMotionEnabled(t){this.motionEnabled=t,this.fishSystem&&this.fishSystem.setMotionEnabled(t),this.particleSystem&&this.particleSystem.setEnabled(t),this.aquascaping&&this.aquascaping.setMotionEnabled(t)}setAdvancedEffects(t){this.advancedEffectsEnabled=t}getPerformanceStats(){return{...this.stats}}enableAutoRotate(t){this.controls.autoRotate=t}setWaterQuality(t){}setupEventListeners(){window.addEventListener("resize",this.handleResize)}dispose(){this.stop(),window.removeEventListener("resize",this.handleResize),this.spiralDecorations&&this.spiralDecorations.dispose(),this.godRaysEffect&&this.godRaysEffect.dispose(),this.renderer.dispose(),this.controls.dispose(),this.composer.dispose()}}class bs{constructor(){c(this,"audioContext",null);c(this,"masterGain",null);c(this,"isEnabled",!1);c(this,"waterAmbientCreated",!1);this.setupAudioContext()}setupAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.connect(this.audioContext.destination),this.masterGain.gain.setValueAtTime(1,this.audioContext.currentTime)}catch(t){console.warn("Web Audio API not supported:",t)}}createWaterAmbient(){if(!this.audioContext||!this.masterGain)return;const t=this.audioContext.sampleRate*4,s=this.audioContext.createBuffer(2,t,this.audioContext.sampleRate);for(let h=0;h<s.numberOfChannels;h++){const d=s.getChannelData(h);let u=0;for(let g=0;g<t;g++){const p=Math.random()*2-1,w=(u+.02*p)/1.02;u=w,d[g]=w*.6}}const e=this.audioContext.createBufferSource();e.buffer=s,e.loop=!0;const a=this.audioContext.createBiquadFilter();a.type="lowpass",a.frequency.setValueAtTime(800,this.audioContext.currentTime),a.Q.setValueAtTime(1,this.audioContext.currentTime);const o=this.audioContext.createBiquadFilter();o.type="highpass",o.frequency.setValueAtTime(100,this.audioContext.currentTime);const n=this.audioContext.createConvolver();n.buffer=this.createReverbBuffer();const r=this.audioContext.createGain(),l=this.audioContext.createGain();r.gain.setValueAtTime(.9,this.audioContext.currentTime),l.gain.setValueAtTime(.3,this.audioContext.currentTime),e.connect(a),a.connect(o),o.connect(r),r.connect(this.masterGain),o.connect(n),n.connect(l),l.connect(this.masterGain),e.start(0)}createReverbBuffer(){if(!this.audioContext)throw new Error("AudioContext not available");const t=this.audioContext.sampleRate,s=t*2,e=this.audioContext.createBuffer(2,s,t);for(let a=0;a<e.numberOfChannels;a++){const o=e.getChannelData(a);for(let n=0;n<s;n++){const r=Math.pow(1-n/s,2);o[n]=(Math.random()*2-1)*r*.2}}return e}setEnabled(t){this.isEnabled=t,!(!this.audioContext||!this.masterGain)&&(t?(this.waterAmbientCreated||(this.createWaterAmbient(),this.waterAmbientCreated=!0),this.audioContext.state==="suspended"&&this.audioContext.resume(),this.masterGain.gain.cancelScheduledValues(this.audioContext.currentTime),this.masterGain.gain.setValueAtTime(0,this.audioContext.currentTime),this.masterGain.gain.linearRampToValueAtTime(1,this.audioContext.currentTime+1)):(this.masterGain.gain.cancelScheduledValues(this.audioContext.currentTime),this.masterGain.gain.setValueAtTime(this.masterGain.gain.value,this.audioContext.currentTime),this.masterGain.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+.5)))}setVolume(t){if(!this.audioContext||!this.masterGain)return;const s=Math.max(0,Math.min(1,t));this.masterGain.gain.setValueAtTime(s*1,this.audioContext.currentTime)}playBubbleSound(){if(!this.audioContext||!this.isEnabled)return;const t=this.audioContext.createOscillator(),s=this.audioContext.createGain();t.type="sine",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(400,this.audioContext.currentTime+.1),s.gain.setValueAtTime(.1,this.audioContext.currentTime),s.gain.exponentialRampToValueAtTime(.001,this.audioContext.currentTime+.1),t.connect(s),s.connect(this.masterGain),t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+.1)}playFishSwimSound(){if(!this.audioContext||!this.isEnabled)return;const t=this.audioContext.createOscillator(),s=this.audioContext.createGain(),e=this.audioContext.createBiquadFilter();t.type="sawtooth",t.frequency.setValueAtTime(60,this.audioContext.currentTime),e.type="lowpass",e.frequency.setValueAtTime(200,this.audioContext.currentTime),s.gain.setValueAtTime(.03,this.audioContext.currentTime),s.gain.exponentialRampToValueAtTime(.001,this.audioContext.currentTime+.3),t.connect(e),e.connect(s),s.connect(this.masterGain),t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+.3)}dispose(){this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}class vs{constructor(){c(this,"scene",null);c(this,"audioManager");c(this,"motionToggle");c(this,"soundToggle");c(this,"effectsToggle");c(this,"qualitySelect");c(this,"statsDisplay");c(this,"prefersReducedMotion");c(this,"performanceMonitor",null);this.audioManager=new bs,this.motionToggle=document.getElementById("motion-toggle"),this.soundToggle=document.getElementById("sound-toggle"),this.effectsToggle=document.getElementById("effects-toggle"),this.qualitySelect=document.getElementById("quality-select"),this.statsDisplay=document.getElementById("stats-display"),this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.init()}async init(){this.showLoadingScreen(),await this.loadAssets();const t=document.getElementById("canvas-container");t&&(this.scene=new Ms(t),this.setupEventListeners(),this.startPerformanceMonitoring(),this.prefersReducedMotion&&(this.motionToggle.checked=!1,this.scene.setMotionEnabled(!1)),this.scene.start(),setTimeout(()=>{this.hideLoadingScreen()},2e3))}showLoadingScreen(){const t=document.getElementById("lottie-bubbles");if(!t)return;const s={container:t,renderer:"svg",loop:!0,autoplay:!0,animationData:{v:"5.5.7",fr:30,ip:0,op:60,w:200,h:200,nm:"Bubbles",ddd:0,assets:[],layers:[{ddd:0,ind:1,ty:4,nm:"Bubble 1",sr:1,ks:{o:{a:0,k:100},r:{a:0,k:0},p:{a:1,k:[{i:{x:.5,y:1},o:{x:.5,y:0},t:0,s:[100,180,0],to:[0,-30,0],ti:[0,30,0]},{t:60,s:[100,20,0]}]},a:{a:0,k:[0,0,0]},s:{a:0,k:[100,100,100]}},ao:0,shapes:[{ty:"gr",it:[{ind:0,ty:"el",s:{a:0,k:[20,20]},p:{a:0,k:[0,0]}},{ty:"st",c:{a:0,k:[.42,.78,.84,1]},o:{a:0,k:100},w:{a:0,k:2}},{ty:"fl",c:{a:0,k:[.42,.78,.84,.3]},o:{a:0,k:30}},{ty:"tr",p:{a:0,k:[0,0]},a:{a:0,k:[0,0]},s:{a:0,k:[100,100]},r:{a:0,k:0},o:{a:0,k:100}}]}],ip:0,op:60,st:0}]}};ss.loadAnimation(s)}hideLoadingScreen(){const t=document.getElementById("loading-screen");t&&(t.style.transition="opacity 0.5s",t.style.opacity="0",setTimeout(()=>{t.style.display="none"},500))}async loadAssets(){return new Promise(t=>{setTimeout(t,1e3)})}setupEventListeners(){var t,s,e,a;(t=this.motionToggle)==null||t.addEventListener("change",()=>{this.scene&&this.scene.setMotionEnabled(this.motionToggle.checked)}),(s=this.soundToggle)==null||s.addEventListener("change",()=>{this.audioManager.setEnabled(this.soundToggle.checked)}),(e=this.effectsToggle)==null||e.addEventListener("change",()=>{this.scene&&this.scene.setAdvancedEffects(this.effectsToggle.checked)}),(a=this.qualitySelect)==null||a.addEventListener("change",()=>{if(this.scene){const o=this.qualitySelect.value;this.scene.setWaterQuality(o),o==="low"&&(this.effectsToggle.checked=!1,this.scene.setAdvancedEffects(!1))}}),window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",o=>{o.matches&&(this.motionToggle.checked=!1,this.scene&&this.scene.setMotionEnabled(!1))})}startPerformanceMonitoring(){this.performanceMonitor=setInterval(()=>{if(this.scene&&this.statsDisplay){const t=this.scene.getPerformanceStats();this.statsDisplay.innerHTML=`
          <div>FPS: ${t.fps}</div>
          <div>Frame Time: ${t.frameTime.toFixed(1)}ms</div>
          <div>Fish Visible: ${t.fishVisible}</div>
          <div>Draw Calls: ${t.drawCalls}</div>
        `,t.fps<30&&t.fps>0&&this.autoOptimizePerformance()}},1e3)}autoOptimizePerformance(){if(this.scene){if(this.effectsToggle.checked){this.effectsToggle.checked=!1,this.scene.setAdvancedEffects(!1),console.log("Auto-optimization: Disabled advanced effects");return}if(this.qualitySelect.value==="high"){this.qualitySelect.value="medium",this.scene.setWaterQuality("medium"),console.log("Auto-optimization: Reduced water quality to medium");return}this.qualitySelect.value==="medium"&&(this.qualitySelect.value="low",this.scene.setWaterQuality("low"),console.log("Auto-optimization: Reduced water quality to low"))}}dispose(){this.performanceMonitor&&(clearInterval(this.performanceMonitor),this.performanceMonitor=null)}}document.addEventListener("DOMContentLoaded",()=>{new vs});
